ä»¥ä¸‹æ˜¯åŸºäºä¹‹å‰ MVVM ç¤ºä¾‹çš„ **åŠŸèƒ½æ‰©å±•å®ç°**ï¼Œé€šè¿‡åè®®å’Œé—­åŒ…å®ç°æ›´è§„èŒƒçš„æ¨¡å—é€šä¿¡ï¼ŒåŒæ—¶å¢åŠ ç½‘ç»œè¯·æ±‚å’Œé”™è¯¯å¤„ç†åŠŸèƒ½ï¼š

---

### ä¸€ã€åè®®å®šä¹‰ï¼ˆæ ¸å¿ƒè§£è€¦ï¼‰
```swift
// MARK: - åè®®å®šä¹‰
protocol UserViewModelProtocol: AnyObject {
    // æ•°æ®ç»‘å®š
    var onLoading: ((Bool) -> Void)? { get set }
    var onDataUpdated: ((UserDisplayData) -> Void)? { get set }
    var onError: ((String) -> Void)? { get set }
    
    // ä¸šåŠ¡æ–¹æ³•
    func loadUserData()
    func toggleVIPStatus()
    func updateUserName(_ name: String)
}
```

---

### äºŒã€ViewModel å®ç°ï¼ˆå®Œæ•´ç‰ˆï¼‰
```swift
class UserViewModel: UserViewModelProtocol {
    
    // MARK: - æ•°æ®ç»‘å®šé—­åŒ…
    var onLoading: ((Bool) -> Void)?
    var onDataUpdated: ((UserDisplayData) -> Void)?
    var onError: ((String) -> Void)?
    
    // MARK: - ä¸šåŠ¡æ•°æ®
    private var user: User? {
        didSet {
            guard let user = user else { return }
            processDisplayData(user)
        }
    }
    
    private let apiService: UserAPIServiceProtocol
    
    // ä¾èµ–æ³¨å…¥ï¼ˆä¾¿äºæµ‹è¯•ï¼‰
    init(apiService: UserAPIServiceProtocol = UserAPIService()) {
        self.apiService = apiService
    }
    
    // MARK: - ä¸šåŠ¡é€»è¾‘
    func loadUserData() {
        onLoading?(true)
        
        apiService.fetchUser { [weak self] result in
            self?.onLoading?(false)
            
            switch result {
            case .success(let user):
                self?.user = user
            case .failure(let error):
                self?.onError?(error.localizedDescription)
            }
        }
    }
    
    func toggleVIPStatus() {
        guard var user = user else { return }
        user.isVIP.toggle()
        self.user = user // è§¦å‘ didSet
    }
    
    func updateUserName(_ name: String) {
        guard !name.isEmpty else {
            onError?("ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
            return
        }
        
        guard var user = user else { return }
        user.name = name
        self.user = user
    }
    
    // MARK: - æ•°æ®å¤„ç†
    private func processDisplayData(_ user: User) {
        let displayData = UserDisplayData(
            name: "å§“å: \(user.name)",
            email: "é‚®ç®±: \(user.email)",
            status: user.isVIP ? "ğŸŒŸ VIP" : ""
        )
        onDataUpdated?(displayData)
    }
}
```

---

### ä¸‰ã€ç½‘ç»œæœåŠ¡å±‚ï¼ˆåè®®+å®ç°ï¼‰
```swift
// ç½‘ç»œæœåŠ¡åè®®
protocol UserAPIServiceProtocol {
    func fetchUser(completion: @escaping (Result<User, Error>) -> Void)
}

// å…·ä½“å®ç°
class UserAPIService: UserAPIServiceProtocol {
    func fetchUser(completion: @escaping (Result<User, Error>) -> Void) {
        // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
        DispatchQueue.global().asyncAfter(deadline: .now() + 1) {
            let user = User(id: 1, name: "å¼ ä¸‰", email: "zhangsan@example.com", isVIP: false)
            completion(.success(user))
            
            // æ¨¡æ‹Ÿé”™è¯¯
            // completion(.failure(NSError(domain: "com.example", code: 500)))
        }
    }
}
```

---

### å››ã€View æ§åˆ¶å™¨å®ç°ï¼ˆå®Œæ•´äº¤äº’ï¼‰
```swift
class UserViewController: UIViewController {
    
    // MARK: - UI ç»„ä»¶
    private let nameLabel = UILabel()
    private let emailLabel = UILabel()
    private let statusLabel = UILabel()
    private let toggleButton = UIButton(type: .system)
    private let nameTextField = UITextField()
    private let loadingIndicator = UIActivityIndicatorView(style: .medium)
    
    private var viewModel: UserViewModelProtocol!
    
    // MARK: - ç”Ÿå‘½å‘¨æœŸ
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        setupViewModel()
        viewModel.loadUserData()
    }
    
    // MARK: - UI è®¾ç½®
    private func setupUI() {
        view.backgroundColor = .white
        
        // å¸ƒå±€ä»£ç ç•¥...
        nameTextField.addTarget(self, action: #selector(nameDidChange), for: .editingChanged)
        toggleButton.addTarget(self, action: #selector(didTapButton), for: .touchUpInside)
    }
    
    // MARK: - ViewModel ç»‘å®š
    private func setupViewModel() {
        viewModel = UserViewModel()
        
        viewModel.onLoading = { [weak self] isLoading in
            isLoading ? self?.loadingIndicator.startAnimating() : self?.loadingIndicator.stopAnimating()
        }
        
        viewModel.onDataUpdated = { [weak self] data in
            self?.nameLabel.text = data.name
            self?.emailLabel.text = data.email
            self?.statusLabel.text = data.status
        }
        
        viewModel.onError = { [weak self] message in
            let alert = UIAlertController(title: "é”™è¯¯", message: message, preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ç¡®å®š", style: .default))
            self?.present(alert, animated: true)
        }
    }
    
    // MARK: - ç”¨æˆ·äº¤äº’
    @objc private func didTapButton() {
        viewModel.toggleVIPStatus()
    }
    
    @objc private func nameDidChange() {
        viewModel.updateUserName(nameTextField.text ?? "")
    }
}
```

---

### äº”ã€Mermaid äº¤äº’æµç¨‹å›¾
![[003 Mermaid äº¤äº’æµç¨‹å›¾.svg]]
%%
```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant View as UserViewController
    participant ViewModel as UserViewModel
    participant Service as APIService
    participant Model as User

    View->>ViewModel: loadUserData()
    ViewModel->>Service: fetchUser()
    Service-->>ViewModel: è¿”å›Useræ•°æ®
    ViewModel->>ViewModel: å¤„ç†æ•°æ® (processDisplayData)
    ViewModel-->>View: onDataUpdated(displayData)
    View->>View: æ›´æ–°UI
    
    User->>View: ç‚¹å‡»åˆ‡æ¢VIPæŒ‰é’®
    View->>ViewModel: toggleVIPStatus()
    ViewModel->>Model: ä¿®æ”¹isVIPçŠ¶æ€
    Model-->>ViewModel: è§¦å‘didSet
    ViewModel->>ViewModel: processDisplayData()
    ViewModel-->>View: onDataUpdated(æ–°æ•°æ®)
    
    User->>View: è¾“å…¥æ–°ç”¨æˆ·å
    View->>ViewModel: updateUserName(text)
    ViewModel->>Model: éªŒè¯å¹¶æ›´æ–°name
    Model-->>ViewModel: è§¦å‘didSet
    ViewModel-->>View: onError(æç¤º)/onDataUpdated(æ–°æ•°æ®)
```
%%


---

### å…­ã€å…³é”®ä¼˜åŒ–ç‚¹è¯´æ˜

1. **åè®®è§£è€¦**  
   - å®šä¹‰ `UserViewModelProtocol` å’Œ `UserAPIServiceProtocol`  
   - å®ç°æ¨¡å—é—´ä¾èµ–æ¥å£è€Œéå…·ä½“å®ç°ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•å’Œæ›¿æ¢å®ç°

2. **çŠ¶æ€ç®¡ç†é—­ç¯**  
   - é€šè¿‡ `onLoading` é—­åŒ…æ§åˆ¶åŠ è½½æŒ‡ç¤ºå™¨  
   - é€šè¿‡ `onError` ç»Ÿä¸€å¤„ç†é”™è¯¯æç¤º

3. **æ•°æ®æµæ¸…æ™°åŒ–**  
   - ç”¨æˆ·è¾“å…¥é€šè¿‡ `nameDidChange` å®æ—¶åŒæ­¥åˆ° ViewModel  
   - ViewModel å¤„ç†æ•°æ®éªŒè¯å’Œä¸šåŠ¡é€»è¾‘

4. **ä¾èµ–æ³¨å…¥**  
   ```swift
   init(apiService: UserAPIServiceProtocol = UserAPIService())
   ```
   æ”¯æŒåœ¨æµ‹è¯•æ—¶æ³¨å…¥ Mock æœåŠ¡

---

### ä¸ƒã€å•å…ƒæµ‹è¯•ç¤ºä¾‹
```swift
class MockAPIService: UserAPIServiceProtocol {
    var result: Result<User, Error>!
    func fetchUser(completion: @escaping (Result<User, Error>) -> Void) {
        completion(result)
    }
}

class UserViewModelTests: XCTestCase {
    func testVIPToggle() {
        // å‡†å¤‡
        let mockService = MockAPIService()
        let vm = UserViewModel(apiService: mockService)
        vm.user = User(id: 1, name: "Test", email: "test@example.com", isVIP: false)
        
        // æ“ä½œ
        vm.toggleVIPStatus()
        
        // æ–­è¨€
        XCTAssertTrue(vm.user?.isVIP == true)
    }
}
```

---

é€šè¿‡ä»¥ä¸Šæ‰©å±•ï¼Œä»£ç å®ç°äº†ï¼š
- å®Œæ•´çš„ç½‘ç»œè¯·æ±‚æµç¨‹
- ç”¨æˆ·è¾“å…¥å®æ—¶éªŒè¯
- é”™è¯¯ç»Ÿä¸€å¤„ç†
- åè®®åŒ–æ¨¡å—è§£è€¦
- å¯æµ‹è¯•æ€§å¢å¼º

è¿™ç§è®¾è®¡æ¨¡å¼ç‰¹åˆ«é€‚åˆä¸­å¤§å‹é¡¹ç›®ï¼Œèƒ½æ˜¾è‘—æå‡ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚